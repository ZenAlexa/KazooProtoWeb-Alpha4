# Phase 2 - Expression Features Specification

**ç‰ˆæœ¬**: Phase 2 Draft 1
**æ—¥æœŸ**: 2025-10-30
**ä½œè€…**: Ziming Wang & Claude
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## 1. æ¦‚è¿° (Overview)

Phase 2 çš„æ ¸å¿ƒç›®æ ‡æ˜¯ä»åŸå§‹éŸ³é«˜æ£€æµ‹æ•°æ®ä¸­æå–**è¡¨ç°åŠ›ç‰¹å¾** (Expressive Features)ï¼Œä¸ºåˆæˆå¼•æ“æä¾›æ›´ä¸°å¯Œçš„æ§åˆ¶ç»´åº¦ï¼Œæ˜¾è‘—æå‡å£°éŸ³è¡¨ç°åŠ›å’ŒéŸ³ä¹æ€§ã€‚

### è®¾è®¡åŸåˆ™

1. **å¯ç»´æŠ¤æ€§ (Maintainability)**: æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»æ¸…æ™°
2. **å¯éªŒè¯æ€§ (Testability)**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰å•å…ƒæµ‹è¯•å’Œç‹¬ç«‹éªŒè¯æ–¹æ³•
3. **å¯æ‰©å±•æ€§ (Extensibility)**: æ˜“äºæ·»åŠ æ–°ç‰¹å¾ï¼Œä¸å½±å“ç°æœ‰ä»£ç 

---

## 2. è¡¨ç°åŠ›æŒ‡æ ‡å®šä¹‰ (Feature Definitions)

### 2.1 æ ¸å¿ƒæŒ‡æ ‡ (Core Features)

| æŒ‡æ ‡åç§° | è‹±æ–‡åç§° | æ•°å€¼èŒƒå›´ | å•ä½ | ç”¨é€” |
|---------|---------|---------|------|------|
| **éŸ³é«˜** | `frequency` | 80-800 | Hz | åŸºç¡€éŸ³é«˜æ§åˆ¶ (å·²å®ç°) |
| **éŸ³ç¬¦** | `note` | å­—ç¬¦ä¸² | å¦‚ "C4" | éŸ³ç¬¦æ˜¾ç¤º (å·²å®ç°) |
| **ç½®ä¿¡åº¦** | `confidence` | 0-1 | æ— é‡çº² | æ£€æµ‹å¯é æ€§ (å·²å®ç°) |

### 2.2 åŠ¨æ€ç‰¹å¾ (Dynamic Features)

#### 2.2.1 éŸ³é‡ (Volume)
- **å±æ€§å**: `volumeDb`
- **æ•°å€¼èŒƒå›´**: -60 ~ 0 dB
- **è®¡ç®—æ–¹æ³•**: `20 * log10(RMS)`
- **ç”¨é€”**:
  - åŠ¨æ€æ§åˆ¶ (Velocity)
  - è‡ªåŠ¨éŸ³é‡é—¨é™ (Gate)
  - èµ·éŸ³æ£€æµ‹è¾…åŠ©
- **å¹³æ»‘**: EMA, Î±=0.3

#### 2.2.2 éŸ³é‡çº¿æ€§ (Volume Linear)
- **å±æ€§å**: `volumeLinear`
- **æ•°å€¼èŒƒå›´**: 0-1 (å½’ä¸€åŒ–)
- **è®¡ç®—æ–¹æ³•**: RMS ç›´æ¥æ˜ å°„
- **ç”¨é€”**:
  - åˆæˆå™¨ Velocity å‚æ•°
  - UI å¯è§†åŒ–
- **å¹³æ»‘**: EMA, Î±=0.3

---

### 2.3 éŸ³é«˜ç²¾åº¦ç‰¹å¾ (Pitch Precision Features)

#### 2.3.1 éŸ³åˆ†åç§» (Cents Deviation)
- **å±æ€§å**: `cents`
- **æ•°å€¼èŒƒå›´**: -50 ~ +50 cents
- **è®¡ç®—æ–¹æ³•**:
  ```
  cents = 1200 * log2(frequency / targetFrequency)
  ```
  å…¶ä¸­ `targetFrequency` ä¸ºæœ€æ¥è¿‘çš„åäºŒå¹³å‡å¾‹éŸ³é«˜
- **ç”¨é€”**:
  - **Vibrato æ§åˆ¶**: |cents| > 10 â†’ è‡ªåŠ¨ Vibrato depth
  - **Pitch Bend**: ç›´æ¥æ˜ å°„åˆ° Pitch Bend Amount
  - **éŸ³å‡†å¯è§†åŒ–**: UI æ˜¾ç¤ºå”±å¾—å‡†ä¸å‡†
- **å¹³æ»‘**: Kalman Filter (Q=0.001, R=0.1)

#### 2.3.2 éŸ³é«˜ç¨³å®šæ€§ (Pitch Stability)
- **å±æ€§å**: `pitchStability`
- **æ•°å€¼èŒƒå›´**: 0-1 (0=ä¸ç¨³å®š, 1=éå¸¸ç¨³å®š)
- **è®¡ç®—æ–¹æ³•**:
  ```
  stability = 1 / (1 + cents_variance)
  ```
  ä½¿ç”¨æœ€è¿‘ 10 å¸§çš„ cents æ–¹å·®
- **ç”¨é€”**:
  - è‡ªé€‚åº”å¹³æ»‘å¼ºåº¦
  - éŸ³è´¨è¯„ä¼°æŒ‡æ ‡
  - UI åé¦ˆ

---

### 2.4 æ—¶åŸŸç‰¹å¾ (Temporal Features)

#### 2.4.1 èµ·éŸ³æ£€æµ‹ (Onset Detection)
- **å±æ€§å**: `articulation`
- **æ•°å€¼ç±»å‹**: æšä¸¾å­—ç¬¦ä¸²
- **å¯èƒ½å€¼**:
  - `"attack"` - æ–°éŸ³ç¬¦å¼€å§‹ (éŸ³é‡çªå¢)
  - `"sustain"` - éŸ³ç¬¦æŒç»­ä¸­
  - `"release"` - éŸ³ç¬¦é‡Šæ”¾/æ¶ˆå¤±
  - `"silence"` - é™éŸ³çŠ¶æ€
- **æ£€æµ‹ç®—æ³•**:
  ```
  èƒ½é‡åŒ…ç»œçªå¢æ£€æµ‹ (Energy Envelope)
  é˜ˆå€¼: volumeDb å¢åŠ  > 6dB åœ¨ 3 å¸§å†… (~15ms)
  ```
- **ç”¨é€”**:
  - è§¦å‘æ–°éŸ³ç¬¦ (Legacy Mode)
  - ADSR Envelope é‡ç½®
  - éŸ³å¤´æ¸…æ™°åº¦æ§åˆ¶

#### 2.4.2 èµ·éŸ³æ—¶é—´ (Attack Time)
- **å±æ€§å**: `attackTime`
- **æ•°å€¼èŒƒå›´**: 0-200 ms
- **è®¡ç®—æ–¹æ³•**: ä»é™éŸ³åˆ°å³°å€¼éŸ³é‡çš„æ—¶é—´
- **ç”¨é€”**:
  - éŸ³å¤´é”åº¦æ§åˆ¶
  - UI æ¼”å¥é£æ ¼åˆ†æ

---

### 2.5 é¢‘åŸŸç‰¹å¾ (Spectral Features)

#### 2.5.1 é¢‘è°±è´¨å¿ƒ (Spectral Centroid)
- **å±æ€§å**: `spectralCentroid`
- **æ•°å€¼èŒƒå›´**: 0-8000 Hz
- **è®¡ç®—æ–¹æ³•**:
  ```
  centroid = Î£(f[i] * magnitude[i]) / Î£(magnitude[i])
  ```
- **ç”¨é€”**:
  - éŸ³è‰²äº®åº¦ (Brightness) æŒ‡æ ‡
  - Filter Cutoff æ§åˆ¶

#### 2.5.2 éŸ³è‰²äº®åº¦ (Brightness)
- **å±æ€§å**: `brightness`
- **æ•°å€¼èŒƒå›´**: 0-1 (å½’ä¸€åŒ–)
- **è®¡ç®—æ–¹æ³•**:
  ```
  brightness = centroid / (sampleRate / 2)
  ```
  æ˜ å°„åˆ° 0-1 åŒºé—´
- **ç”¨é€”**:
  - **Filter Cutoff æ§åˆ¶**
  - **Formant Shift** (å…±æŒ¯å³°åç§»)
  - UI éŸ³è‰²å¯è§†åŒ–
- **å¹³æ»‘**: EMA, Î±=0.2

#### 2.5.3 å…±æŒ¯å³°ä¼°è®¡ (Formant Estimation)
- **å±æ€§å**: `formant` (ç®€åŒ–ç‰ˆ)
- **æ•°å€¼èŒƒå›´**: 500-3000 Hz (ç¬¬ä¸€å…±æŒ¯å³° F1)
- **è®¡ç®—æ–¹æ³•**:
  - Phase 2: ä½¿ç”¨ Spectral Centroid è¿‘ä¼¼
  - Phase 3+: LPC (Linear Predictive Coding) ç²¾ç¡®æå–
- **ç”¨é€”**:
  - å…ƒéŸ³è¯†åˆ« (a/e/i/o/u)
  - éŸ³è‰²å˜åŒ– (Timbre Morphing)

#### 2.5.4 é¢‘è°±å¹³å¦åº¦ (Spectral Flatness)
- **å±æ€§å**: `breathiness`
- **æ•°å€¼èŒƒå›´**: 0-1 (0=çº¯éŸ³, 1=ç™½å™ªå£°)
- **è®¡ç®—æ–¹æ³•**:
  ```
  flatness = geometricMean(spectrum) / arithmeticMean(spectrum)
  ```
- **ç”¨é€”**:
  - **å™ªå£°é‡æ§åˆ¶** (Breathiness/Air)
  - **Filter Resonance** åå‘è°ƒåˆ¶
  - éŸ³è´¨è¯„ä¼°
- **å¹³æ»‘**: EMA, Î±=0.25

---

## 3. æ•°æ®ç»“æ„è®¾è®¡ (Data Structures)

### 3.1 PitchFrame (ç»Ÿä¸€æ•°æ®å¸§)

```javascript
/**
 * PitchFrame - å•å¸§å®Œæ•´çš„éŸ³é«˜å’Œè¡¨ç°åŠ›æ•°æ®
 * @typedef {Object} PitchFrame
 */
const PitchFrame = {
  // ===== æ—¶é—´æˆ³ =====
  timestamp: 0,                    // æ—¶é—´æˆ³ (ms)

  // ===== åŸºç¡€éŸ³é«˜æ•°æ® (Phase 1 å·²æœ‰) =====
  frequency: 0,                    // é¢‘ç‡ (Hz)
  note: "C4",                      // éŸ³ç¬¦åç§°
  octave: 4,                       // å…«åº¦
  confidence: 0,                   // ç½®ä¿¡åº¦ (0-1)

  // ===== Phase 2 æ–°å¢: åŠ¨æ€ç‰¹å¾ =====
  volumeDb: -60,                   // éŸ³é‡ (dB)
  volumeLinear: 0,                 // éŸ³é‡çº¿æ€§ (0-1)

  // ===== Phase 2 æ–°å¢: éŸ³é«˜ç²¾åº¦ =====
  cents: 0,                        // éŸ³åˆ†åç§» (-50 ~ +50)
  pitchStability: 1,               // éŸ³é«˜ç¨³å®šæ€§ (0-1)

  // ===== Phase 2 æ–°å¢: æ—¶åŸŸç‰¹å¾ =====
  articulation: "sustain",         // èµ·éŸ³çŠ¶æ€: attack/sustain/release/silence
  attackTime: 0,                   // èµ·éŸ³æ—¶é—´ (ms)

  // ===== Phase 2 æ–°å¢: é¢‘åŸŸç‰¹å¾ =====
  spectralCentroid: 0,             // é¢‘è°±è´¨å¿ƒ (Hz)
  brightness: 0.5,                 // äº®åº¦ (0-1)
  formant: 1000,                   // å…±æŒ¯å³°ä¼°è®¡ (Hz)
  breathiness: 0,                  // æ°”å£°åº¦ (0-1)

  // ===== åŸå§‹æ•°æ® (è°ƒè¯•ç”¨) =====
  rawAudioBuffer: null             // Float32Array, å¯é€‰
};
```

### 3.2 ç‰¹å¾æå–å™¨é…ç½®

```javascript
/**
 * ExpressiveFeaturesConfig - ç‰¹å¾æå–å™¨é…ç½®
 */
const ExpressiveFeaturesConfig = {
  sampleRate: 44100,

  // å¹³æ»‘é…ç½®
  smoothing: {
    cents: {
      method: 'kalman',          // 'kalman' | 'ema' | 'none'
      Q: 0.001,                  // è¿‡ç¨‹å™ªå£°
      R: 0.1                     // æµ‹é‡å™ªå£°
    },
    volume: {
      method: 'ema',
      alpha: 0.3
    },
    brightness: {
      method: 'ema',
      alpha: 0.2
    },
    breathiness: {
      method: 'ema',
      alpha: 0.25
    }
  },

  // èµ·éŸ³æ£€æµ‹é…ç½®
  onset: {
    energyThreshold: 6,          // dB å¢é‡é˜ˆå€¼
    timeWindow: 3,               // æ£€æµ‹çª—å£ (å¸§æ•°)
    minSilenceDuration: 100      // æœ€å°é™éŸ³æ—¶é•¿ (ms)
  },

  // é¢‘åŸŸåˆ†æé…ç½®
  spectral: {
    fftSize: 2048,               // FFT çª—å£å¤§å°
    minFrequency: 80,            // æœ€ä½åˆ†æé¢‘ç‡
    maxFrequency: 8000           // æœ€é«˜åˆ†æé¢‘ç‡
  }
};
```

---

## 4. æ¨¡å—æ¶æ„ (Module Architecture)

### 4.1 æ¨¡å—ä¾èµ–å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Main Application                        â”‚
â”‚                      (main.js)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ExpressiveFeatures         â”‚
              â”‚   (expressive-features.js)   â”‚
              â”‚   [ç»Ÿä¸€ç‰¹å¾æå–å…¥å£]          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                    â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OnsetDetector â”‚   â”‚SpectralFeaturesâ”‚   â”‚SmoothingFilters  â”‚
â”‚ (èµ·éŸ³æ£€æµ‹)     â”‚   â”‚(é¢‘åŸŸç‰¹å¾)       â”‚   â”‚(å¹³æ»‘ç®—æ³•)         â”‚
â”‚               â”‚   â”‚                â”‚   â”‚                  â”‚
â”‚ - attack      â”‚   â”‚ - centroid     â”‚   â”‚ - Kalman Filter  â”‚
â”‚ - sustain     â”‚   â”‚ - brightness   â”‚   â”‚ - EMA Filter     â”‚
â”‚ - release     â”‚   â”‚ - flatness     â”‚   â”‚ - Median Filter  â”‚
â”‚ - silence     â”‚   â”‚ - formant      â”‚   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Audio Utilities Library                      â”‚
â”‚                 (audio-utils.js)                             â”‚
â”‚                                                              â”‚
â”‚  - calculateRMS()         - dBToLinear()                     â”‚
â”‚  - calculateCents()       - linearToDb()                     â”‚
â”‚  - frequencyToNote()      - normalizeSpectrum()              â”‚
â”‚  - performFFT()           - calculateVariance()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ¨¡å—èŒè´£

| æ¨¡å—åç§° | æ–‡ä»¶è·¯å¾„ | ä¸»è¦èŒè´£ | è¾“å…¥ | è¾“å‡º |
|---------|---------|---------|------|------|
| **ExpressiveFeatures** | `js/expressive-features.js` | ç»Ÿä¸€ç‰¹å¾æå–å…¥å£ | éŸ³é¢‘ Buffer + Pitch Info | `PitchFrame` |
| **OnsetDetector** | `js/features/onset-detector.js` | èµ·éŸ³çŠ¶æ€æ£€æµ‹ | éŸ³é‡åºåˆ— | `articulation` |
| **SpectralFeatures** | `js/features/spectral-features.js` | é¢‘åŸŸç‰¹å¾æå– | FFT ç»“æœ | `brightness`, `breathiness`, `formant` |
| **SmoothingFilters** | `js/features/smoothing-filters.js` | ä¿¡å·å¹³æ»‘ç®—æ³• | åŸå§‹æ•°å€¼åºåˆ— | å¹³æ»‘åæ•°å€¼ |
| **AudioUtils** | `js/utils/audio-utils.js` | é€šç”¨éŸ³é¢‘å·¥å…·å‡½æ•° | å„ç§éŸ³é¢‘æ•°æ® | è®¡ç®—ç»“æœ |

---

## 5. UI æ˜¾ç¤ºéœ€æ±‚ (UI Display Requirements)

### 5.1 æœ€ä½æ˜¾ç¤ºéœ€æ±‚ (Minimum Viable Display)

#### 5.1.1 å®æ—¶æ•°å€¼æ˜¾ç¤º (å¿…é¡»)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éŸ³é«˜: C4 (261.6 Hz)                â”‚
â”‚  éŸ³åˆ†: +12 cents â–²                  â”‚
â”‚  éŸ³é‡: -12 dB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘          â”‚
â”‚  äº®åº¦: 0.65 (æ˜äº®) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘        â”‚
â”‚  æ°”å£°: 0.15 (æ¸…æ™°) â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘        â”‚
â”‚  çŠ¶æ€: ğŸµ æŒç»­ä¸­ (Sustain)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.1.2 å¯è§†åŒ–ç»„ä»¶ (æ¨è)
- **éŸ³åˆ†æŒ‡ç¤ºå™¨**: å®æ—¶æ˜¾ç¤º Â±50 cents åç§»ï¼Œä¸­å¿ƒä¸ºæ ‡å‡†éŸ³é«˜
- **éŸ³é‡åŒ…ç»œ**: å®æ—¶æ³¢å½¢ï¼Œæ˜¾ç¤º attack/sustain/release
- **é¢‘è°±åˆ†æå™¨**: ç®€åŒ–çš„é¢‘è°±æ˜¾ç¤ºï¼Œé«˜äº® formant åŒºåŸŸ

### 5.2 è°ƒè¯•é¢æ¿ (å¼€å‘è€…æ¨¡å¼)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”§ Expression Features Debug Panel                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Raw Volume (Linear): 0.456                         â”‚
â”‚  Smoothed Volume (dB): -12.3                        â”‚
â”‚  Cents (Raw): +14.2                                 â”‚
â”‚  Cents (Kalman): +12.1                              â”‚
â”‚  Spectral Centroid: 2845 Hz                         â”‚
â”‚  Pitch Stability: 0.89                              â”‚
â”‚  Attack Time: 23ms                                  â”‚
â”‚  Articulation State: sustain (frame 142)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ€§èƒ½ç›®æ ‡ (Performance Targets)

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|---------|
| **ç‰¹å¾æå–å»¶è¿Ÿ** | < 2ms | å•å¸§å¤„ç†æ—¶é—´ |
| **æ€»å»¶è¿Ÿ** | < 20ms | éº¦å…‹é£åˆ°è¾“å‡º |
| **CPU å ç”¨** | < 10% | Chrome æ€§èƒ½ç›‘æ§ |
| **å†…å­˜å ç”¨** | < 50MB | è¿è¡Œ 5 åˆ†é’Ÿå |
| **å¸§ç‡** | 60 FPS | UI åˆ·æ–°ç‡ |

---

## 7. æµ‹è¯•ç­–ç•¥ (Testing Strategy)

### 7.1 å•å…ƒæµ‹è¯• (Unit Tests)

æ¯ä¸ªæ¨¡å—éƒ½éœ€è¦ç‹¬ç«‹çš„å•å…ƒæµ‹è¯•æ–‡ä»¶:

```
tests/
â”œâ”€â”€ smoothing-filters.test.js    # Kalman/EMA ç®—æ³•æµ‹è¯•
â”œâ”€â”€ onset-detector.test.js       # èµ·éŸ³æ£€æµ‹é€»è¾‘æµ‹è¯•
â”œâ”€â”€ spectral-features.test.js    # é¢‘åŸŸç‰¹å¾è®¡ç®—æµ‹è¯•
â”œâ”€â”€ audio-utils.test.js          # å·¥å…·å‡½æ•°æµ‹è¯•
â””â”€â”€ expressive-features.test.js  # ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
```

### 7.2 æµ‹è¯•ç”¨ä¾‹è¦æ±‚

- **Kalman Filter**: ä½¿ç”¨æ­£å¼¦æ³¢ + å™ªå£°éªŒè¯æ”¶æ•›æ€§
- **Onset Detector**: åˆæˆ attack/sustain/silence åºåˆ—éªŒè¯çŠ¶æ€è½¬æ¢
- **Spectral Features**: ä½¿ç”¨æ ‡å‡†æ³¢å½¢ (æ­£å¼¦/æ–¹æ³¢/é”¯é½¿æ³¢) éªŒè¯ç‰¹å¾å€¼
- **Integration**: çœŸå®å½•éŸ³ç‰‡æ®µçš„ç«¯åˆ°ç«¯æµ‹è¯•

### 7.3 å›å½’æµ‹è¯•

- ä¿ç•™ Phase 1 çš„ 8-15ms å»¶è¿Ÿæ€§èƒ½
- ç¡®ä¿æ–°ç‰¹å¾ä¸å½±å“åŸºç¡€éŸ³é«˜æ£€æµ‹ç²¾åº¦

---

## 8. å®ç°ä¼˜å…ˆçº§ (Implementation Priority)

### P0 (æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å®ç°)
1. âœ… `volumeDb`, `volumeLinear` - åŠ¨æ€æ§åˆ¶
2. âœ… `cents` - Vibrato/Pitch Bend æ§åˆ¶
3. âœ… `brightness` - éŸ³è‰²å˜åŒ–
4. âœ… EMA/Kalman å¹³æ»‘ç®—æ³•

### P1 (é‡è¦åŠŸèƒ½ï¼Œå¼ºçƒˆæ¨è)
5. âœ… `articulation` (Onset Detection) - éŸ³å¤´æ§åˆ¶
6. âœ… `breathiness` - å™ªå£°è´¨æ„Ÿ

### P2 (å¢å¼ºåŠŸèƒ½ï¼Œå¯é€‰)
7. âšª `pitchStability` - è‡ªé€‚åº”å¹³æ»‘
8. âšª `formant` - é«˜çº§éŸ³è‰²æ§åˆ¶
9. âšª `attackTime` - æ¼”å¥é£æ ¼åˆ†æ

---

## 9. åˆæˆå¼•æ“æ˜ å°„ (Synth Engine Mapping)

### 9.1 Continuous Mode æ˜ å°„è¡¨

| è¡¨ç°åŠ›ç‰¹å¾ | åˆæˆå‚æ•° | æ˜ å°„å‡½æ•° | æ•ˆæœ |
|-----------|---------|---------|------|
| `cents` | `pitchBend` | ç›´æ¥æ˜ å°„ | å¾®åˆ†éŸ³é«˜å¼¯æ›² |
| `volumeLinear` | `velocity` | çº¿æ€§æ˜ å°„ 0-1 | éŸ³é‡æ§åˆ¶ |
| `brightness` | `filterCutoff` | 200 + brightness * 4000 Hz | æ˜äº®åº¦å˜åŒ– |
| `breathiness` | `noiseLevel` | breathiness * 0.3 | æ°”å£°è´¨æ„Ÿ |
| `articulation` | `envelope.trigger()` | attack â†’ é‡ç½® ADSR | æ¸…æ™°éŸ³å¤´ |

### 9.2 Legacy Mode æ˜ å°„è¡¨

| è¡¨ç°åŠ›ç‰¹å¾ | åˆæˆå‚æ•° | æ˜ å°„å‡½æ•° | æ•ˆæœ |
|-----------|---------|---------|------|
| `cents` | `detune` | cents (ç›´æ¥) | éŸ³åˆ†åç§» |
| `volumeDb` | `velocity` | dB â†’ 0-127 | MIDI Velocity |
| `brightness` | `filterFrequency` | åŒä¸Š | éŸ³è‰²äº®åº¦ |
| `articulation` | `noteOn/noteOff` | attack â†’ noteOn | éŸ³ç¬¦è§¦å‘ |

---

## 10. æˆåŠŸæ ‡å‡† (Success Criteria)

Phase 2 å®Œæˆçš„åˆ¤æ–­æ ‡å‡†:

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ‰€æœ‰ P0/P1 ç‰¹å¾æˆåŠŸæå–å¹¶è¾“å‡º
- âœ… ä¸¤ä¸ªåˆæˆå¼•æ“éƒ½æ”¯æŒæ–°æ•°æ®ç»“æ„
- âœ… UI å®æ—¶æ˜¾ç¤ºæ‰€æœ‰æ ¸å¿ƒæŒ‡æ ‡

### æ€§èƒ½è¾¾æ ‡
- âœ… ç‰¹å¾æå–å»¶è¿Ÿ < 2ms
- âœ… æ€»å»¶è¿Ÿä»ä¿æŒ < 20ms
- âœ… æ— æ˜æ˜¾å¡é¡¿æˆ–å¸§ç‡ä¸‹é™

### ä»£ç è´¨é‡
- âœ… æ‰€æœ‰æ¨¡å—é€šè¿‡å•å…ƒæµ‹è¯• (è¦†ç›–ç‡ > 80%)
- âœ… ä»£ç ç¬¦åˆ ESLint è§„èŒƒ
- âœ… æ–‡æ¡£å®Œæ•´ (JSDoc + ä¸­æ–‡æ³¨é‡Š)

### ç”¨æˆ·ä½“éªŒ
- âœ… å£°éŸ³è¡¨ç°åŠ›æ˜æ˜¾æå‡ (ä¸»è§‚è¯„ä¼°)
- âœ… Vibrato å’ŒéŸ³è‰²å˜åŒ–è‡ªç„¶æµç•…
- âœ… UI åé¦ˆæ¸…æ™°æ˜“æ‡‚

---

## 11. ä¸‹ä¸€æ­¥è¡ŒåŠ¨ (Next Steps)

1. âœ… **Spec æ¾„æ¸…å®Œæˆ** â† å½“å‰æ–‡æ¡£
2. ğŸ”„ **API è®¾è®¡**: å®šä¹‰è¯¦ç»†çš„å‡½æ•°ç­¾åå’Œæ¥å£å¥‘çº¦
3. â³ **åŸºç¡€è®¾æ–½**: å®ç°å¹³æ»‘ç®—æ³• + å•å…ƒæµ‹è¯•
4. â³ **ç‰¹å¾æå–**: é€æ­¥å®ç°å„ä¸ªç‰¹å¾æ¨¡å—
5. â³ **å¼•æ“é›†æˆ**: æ›´æ–°åˆæˆå¼•æ“é€‚é…æ–°æ•°æ®
6. â³ **UI å¢å¼º**: æ·»åŠ å¯è§†åŒ–å’Œå®æ—¶æ˜¾ç¤º
7. â³ **é‡æ„ä¼˜åŒ–**: æå–å…¬å…±åº“ï¼Œæ¸…ç†ä»£ç 

---

**æ–‡æ¡£çŠ¶æ€**: âœ… Phase 2.1 å®Œæˆ
**ä¸‹ä¸€é˜¶æ®µ**: Phase 2.2 - API è®¾è®¡
