<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioWorklet æµ‹è¯• - Phase 1.6</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .status-item:last-child { border-bottom: none; }
        .label { font-weight: 600; color: #334155; }
        .value { color: #64748b; font-family: 'Courier New', monospace; }
        .value.success { color: #10b981; }
        .value.error { color: #ef4444; }
        .value.warning { color: #f59e0b; }

        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary {
            background: #e2e8f0;
            color: #334155;
        }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover { background: #dc2626; }

        #console {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
        }
        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }
        .log-time { color: #64748b; margin-right: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ AudioWorklet æµ‹è¯•é¡µé¢</h1>
        <p class="subtitle">Phase 1.6: éªŒè¯ AudioWorklet åŠ è½½ä¸é€šä¿¡</p>

        <div class="status">
            <div class="status-item">
                <span class="label">æµè§ˆå™¨æ”¯æŒ</span>
                <span class="value" id="browserSupport">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="label">AudioWorklet æ”¯æŒ</span>
                <span class="value" id="workletSupport">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="label">å½“å‰æ¨¡å¼</span>
                <span class="value" id="currentMode">-</span>
            </div>
            <div class="status-item">
                <span class="label">å»¶è¿Ÿ (ç†è®º)</span>
                <span class="value" id="latency">-</span>
            </div>
            <div class="status-item">
                <span class="label">å·²å¤„ç†å¸§æ•°</span>
                <span class="value" id="framesProcessed">0</span>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-primary" id="testWorklet">æµ‹è¯• AudioWorklet</button>
            <button class="btn-secondary" id="testScriptProcessor">æµ‹è¯• ScriptProcessor</button>
            <button class="btn-danger" id="stopBtn" disabled>åœæ­¢</button>
        </div>

        <div id="console"></div>
    </div>

    <script src="js/audio-io.js"></script>
    <script>
        // æ§åˆ¶å°æ—¥å¿—
        const consoleEl = document.getElementById('console');
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
            consoleEl.appendChild(entry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // åŠ«æŒ console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
            log(message, 'info');
        };

        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
            log(message, 'error');
        };

        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
            log(message, 'warning');
        };

        // æ£€æµ‹æµè§ˆå™¨æ”¯æŒ
        const ua = navigator.userAgent;
        let browserName = 'Unknown';
        if (ua.indexOf('Chrome') > -1) browserName = 'Chrome';
        else if (ua.indexOf('Firefox') > -1) browserName = 'Firefox';
        else if (ua.indexOf('Safari') > -1) browserName = 'Safari';
        else if (ua.indexOf('Edge') > -1) browserName = 'Edge';

        document.getElementById('browserSupport').textContent = browserName;
        document.getElementById('browserSupport').className = 'value success';

        // æ£€æµ‹ AudioWorklet æ”¯æŒ
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        if (AudioContextClass) {
            const tempCtx = new AudioContextClass();
            const hasWorklet = 'audioWorklet' in tempCtx;
            document.getElementById('workletSupport').textContent = hasWorklet ? 'âœ“ æ”¯æŒ' : 'âœ— ä¸æ”¯æŒ';
            document.getElementById('workletSupport').className = hasWorklet ? 'value success' : 'value error';
            tempCtx.close();
        }

        // åˆ›å»º AudioIO å®ä¾‹
        const audioIO = new AudioIO();

        // æµ‹è¯• AudioWorklet
        document.getElementById('testWorklet').addEventListener('click', async () => {
            try {
                log('===== å¼€å§‹æµ‹è¯• AudioWorklet =====', 'success');

                audioIO.configure({
                    useWorklet: true,
                    workletBufferSize: 128,
                    workletFallback: true,
                    debug: true
                });

                const result = await audioIO.start();

                document.getElementById('currentMode').textContent = result.mode;
                document.getElementById('currentMode').className = result.mode === 'worklet' ? 'value success' : 'value warning';
                document.getElementById('latency').textContent = result.totalLatency + ' ms';
                document.getElementById('stopBtn').disabled = false;

                log(`âœ… å¯åŠ¨æˆåŠŸï¼æ¨¡å¼: ${result.mode}, å»¶è¿Ÿ: ${result.totalLatency}ms`, 'success');

            } catch (error) {
                log(`âŒ å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // æµ‹è¯• ScriptProcessor
        document.getElementById('testScriptProcessor').addEventListener('click', async () => {
            try {
                log('===== å¼€å§‹æµ‹è¯• ScriptProcessor =====', 'success');

                audioIO.configure({
                    useWorklet: false,
                    bufferSize: 2048
                });

                const result = await audioIO.start();

                document.getElementById('currentMode').textContent = result.mode;
                document.getElementById('currentMode').className = 'value warning';
                document.getElementById('latency').textContent = result.totalLatency + ' ms';
                document.getElementById('stopBtn').disabled = false;

                log(`âœ… å¯åŠ¨æˆåŠŸï¼æ¨¡å¼: ${result.mode}, å»¶è¿Ÿ: ${result.totalLatency}ms`, 'success');

            } catch (error) {
                log(`âŒ å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // åœæ­¢
        document.getElementById('stopBtn').addEventListener('click', () => {
            audioIO.stop();
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('currentMode').textContent = '-';
            document.getElementById('latency').textContent = '-';
            log('â¹ï¸ å·²åœæ­¢', 'info');
        });

        // ç›‘å¬çŠ¶æ€å˜åŒ–
        audioIO.onStateChange((state, info) => {
            log(`çŠ¶æ€å˜åŒ–: ${state}`, 'success');
        });

        // ç›‘å¬é”™è¯¯
        audioIO.onError((type, error) => {
            log(`é”™è¯¯ [${type}]: ${error.message}`, 'error');
        });

        // å®šæœŸæ›´æ–°ç»Ÿè®¡
        setInterval(() => {
            if (audioIO.isRunning) {
                const stats = audioIO.getStats();
                document.getElementById('framesProcessed').textContent = stats.framesProcessed;
            }
        }, 1000);

        log('ğŸ‘‹ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œé€‰æ‹©ä¸€ä¸ªæ¨¡å¼å¼€å§‹æµ‹è¯•', 'info');
    </script>
</body>
</html>
